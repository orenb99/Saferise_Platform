// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema


generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}
// Inspector Entity - מפקח (מוסק מהאפיון)
model Inspector {
  inspectorId   String   @id @db.VarChar(9)      // מזהה מפקח (PK)
  fullName      String   @db.VarChar(100)// שם מלא
  email         String   @unique @db.VarChar(100) // כתובת מייל
  phoneNumber   String   @unique @db.VarChar(10)         // טלפון
  password      String   // סיסמה
  employeeId    String   @unique @db.VarChar(20) // מספר עובד
  inspectorType InspectorType      // סוג מפקח 
  regionId      String?   // אזור אחריות
  region        Region?   @relation(fields: [regionId], references: [regionId]) // קשר לאזור
  isActive      Boolean @default(true)  // פעיל
  createdAt     DateTime @default(now()) // תאריך יצירה
  updatedAt     DateTime @updatedAt      // תאריך עדכון
  savedReports  SavedReport[] // קשר לדוחות שמורים
  safetyOrders SafetyOrder[]
  alerts Alert[]
}
enum InspectorType{
  Chief // ראשי
  Regional // אזורי
}


model Product {
  productId String @id @db.VarChar(18) // מזהה מוצר
  name String @db.VarChar(255) // שם מוצר
  productFamily ProductFamily // משפחת מוצר
  createdAt DateTime @default(now()) // תאריך יצירה
  updatedAt DateTime @updatedAt // תאריך עדכון
  assets Asset[] // קשר למתקנים

}

enum ProductFamily {
  Elevator // מעלית
  Lift // מעלון
}
model Region{
  regionId String @id @db.VarChar(18) // מזהה אזור
  name String @db.VarChar(100) // שם אזור
  code String @db.VarChar(10) @unique // קוד אזור
  description String? @db.Text // תיאור
  isActive Boolean @default(true) // פעיל
  createdAt DateTime @default(now()) // תאריך יצירה
  updatedAt DateTime @updatedAt // תאריך עדכון
  inspectors Inspector[] // קשר למפקחים
  sites Site[] // קשר לאתרים
  assetSummaries AssetSummary[] // קשר לסיכומי מעלית
  dashboardMetrics DashboardMetrics[] // קשר למטריקות דשבורד
}

model Address {
  addressId String @id @db.VarChar(18)  // מזהה כתובת
  addressType AddressType // סוג כתובת
  city Int? // עיר
  street Int? // רחוב
  houseNumber Int // מספר בית
  houseEntrance Int // כניסה
  zipcode Int // מיקוד
  geoLocationLatitude Decimal? @db.Decimal(10,8)  // קו אורך
  geoLocationLongitude Decimal? @db.Decimal(10,8)// קו רוחב
  block Int?  // גוש
  plot Int? // חלקה
  createdAt DateTime @default(now())  // תאריך יצירה
  updatedAt DateTime @updatedAt // תאריך עדכון  
  sites Site[] // קשר לאתרים
}

enum AddressType {
  Street // רחוב
  Plot // חלקה
  Coordinates // קואורדינטות
}

/// פרטי אתר
model Site {
  siteId                 String   @id @db.VarChar(18)
  addressId              String   @db.VarChar(18)
  siteOwnerId            String   @db.VarChar(18)
  regionId               String   @db.VarChar(18)
  siteType               SiteType 
  designation            SiteDesignation
  officeSerialNumber     String?  @db.VarChar(50) 
  createdAt            DateTime @default(now())
  updatedAt           DateTime @updatedAt

  address   Address   @relation(fields: [addressId], references: [addressId])
  siteOwner SiteOwner @relation(fields: [siteOwnerId], references: [siteOwnerId])
  region    Region    @relation(fields: [regionId], references: [regionId])
  assets    Asset[]   // קשר למתקנים
}


enum SiteType{ // סוג אתר
  Residential // מגורים
  Industrial // תעשייה
  Construction // אתר בנייה
  Services // שירותים ומסחר
  Government // ממשלתי
}
enum SiteDesignation{ // יעוד אתר
  Residential // מגורים
  Hotel // מלון
  Hospital  // בית חולים
  Government  // ממשלתי
  Industrial  // תעשייה
  ShoppingCenter // מרכז קניות
  Mall    // קניון
}

model SiteOwner {
  siteOwnerId     String   @id @db.VarChar(18)      // מזהה חשבון (PK)
  name          String @db.VarChar(255)   // שם
  identityType  IdentityType      // סוג זיהוי
  businessId            String @db.VarChar(20)   // מספר מזהה ארגון
  phoneNumber   String? @db.VarChar(20) // טלפון
  email         String? @db.VarChar(100) // כתובת מייל
  createdAt     DateTime @default(now()) // תאריך יצירה
  updatedAt     DateTime @updatedAt      // תאריך עדכון
  sites Site[] // קשר לאתרים
}
enum IdentityType{
  AuthorizedDealer // עוסק מורשה
  Association // עמותה
  PrivateCompany // ח.פ
}

model AssetOwner {
  assetOwnerId     String   @id @db.VarChar(18)      // מזהה חשבון (PK)
  name          String @db.VarChar(255)   // שם
  identityType  AssetOwnerIdentityType      // סוג זיהוי
  businessId            String @db.VarChar(20) @unique   // מספר מזהה ארגון
  phoneNumber   String? @db.VarChar(20) // טלפון
  email         String? @db.VarChar(100) // כתובת מייל
  createdAt     DateTime @default(now()) // תאריך יצירה
  updatedAt     DateTime @updatedAt      // תאריך עדכון
  assets Asset[] // קשר למתקנים
}

enum AssetOwnerIdentityType{
  AuthorizedDealer // עוסק מורשה
  Association // עמותה
  PrivateCompany // ח.פ
  HouseCommittee // ועד בית
}
/// חברות השירות
model ServiceCompany {
  serviceCompanyId String    @id @db.VarChar(18)
  name             String    @db.VarChar(255)
  businessId       String    @unique @db.VarChar(20)
  phone            String?   @db.VarChar(20)
  email            String?   @db.VarChar(100)
  address          String?   @db.Text
  isActive         Boolean   @default(true)
  licenseExpiry    DateTime? @db.Date
  createdAt      DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  assets Asset[] // קשר למתקנים
}

/// בודק מוסמך
model Reviewer {
  reviewerId         String   @id @db.VarChar(18)
  fullName          String   @db.VarChar(100)
  phoneNumber        String   @db.VarChar(20)
  email              String   @unique @db.VarChar(100)
  identityType      IdentityType                 
  idNumber         String?   @db.VarChar(9)    
  certificateNumber  String   @unique @db.VarChar(50)
  certificationExpiry DateTime @db.Date
  isActive           Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt       DateTime @updatedAt
  reviews Review[]

}

/// המעלית
model Asset {
  assetId              String   @id @db.VarChar(18)
  productId            String   @db.VarChar(18)
  product              Product  @relation(fields: [productId], references: [productId])
  siteId               String   @db.VarChar(18)
  site                 Site     @relation(fields: [siteId], references: [siteId])
  assetOwnerId         String   @db.VarChar(18)
  assetOwner           AssetOwner @relation(fields: [assetOwnerId], references: [assetOwnerId])
  serviceCompanyId     String?  @db.VarChar(18)
  serviceCompany       ServiceCompany? @relation(fields: [serviceCompanyId], references: [serviceCompanyId])
  name                 String   @db.VarChar(255)
  installDate         DateTime? @db.Date     
  assetPurpose       AssetPurpose     
  serialNumber         String   @unique @db.VarChar(50) 
  officeSerialNumber  String?  @db.VarChar(50)
  status              Status      @default(Active)
  marking             String?  @db.VarChar(100)
  ownerType           OwnerType      
  manufactureDate     DateTime? @db.Date
  engineNumber        String   @db.VarChar(100) 
  cellDoorType        CellDoorType     
  shaftDoorType       ShaftDoorType      
  numberOfDoors      Int   
  description        String   @db.Text 
  usageEndDate        DateTime? @db.Date
  numberOfStations    Int      
  metersHeight        Decimal  @db.Decimal(8,2) 
  weight              Decimal  @db.Decimal(10,2)
  maxPassengers       Int     
  isLifting           Boolean  @default(false)
  liftingDate         DateTime? @db.Date     
  lastInspectionDate   DateTime? @db.Date
  nextInspectionDue    DateTime? @db.Date
  createdAt          DateTime @default(now())
  updatedAt         DateTime @updatedAt
  reviews              Review[] // קשר לתסקירים
  safetyOrders        SafetyOrder[] // קשר לצווי בטיחות
  alerts               Alert[] // קשר להתראות
  assetSummaries      AssetSummary[] // קשר לסיכומי מעלית

}

enum AssetPurpose{
  PassengerElevator // מעלית נוסעים
  FrightList // מעלית משא
  Service // שירות
  Construction // בניין
  Other // אחר
}
enum Status{
  Active // פעיל
  Disabled // מושבת
}
enum OwnerType{
  Company // חברה
  HouseCommittee // ועד בית
  PrivatePerson // אדם פרטי
}

enum CellDoorType{
 Wing // כנף
 AutoCenter // אוטומטיות מרכזיות
 AutoRight // אוטומטיות ימניות
 AutoLeft // אוטומטיות שמאליות
 VerticalManual // אנכי ידני
 VerticalAuto // אנכי אוטומטי
 HorizontalAuto // אופקי אוטומטי
 None // ללא תא דלת
}
enum ShaftDoorType {
  Auto // אוטומטי
  Wing // כנף
  Other //אחר
}

// Review Entity - התסקיר
/// התסקיר
model Review {
  reviewId            String    @id @db.VarChar(18)
  assetId             String    @db.VarChar(18)
  asset               Asset     @relation(fields: [assetId], references: [assetId])
  reviewerId         String    @db.VarChar(18)
  reviewer           Reviewer @relation(fields: [reviewerId], references: [reviewerId])
  assignedInspectorId  String?   @db.VarChar(18)
  reviewDate         DateTime  
  assetSystemSource  String    @db.VarChar(100)
  reviewReason       ReviewReason       
  reviewerNumber     String    @db.VarChar(100)
  reviewerDecision   ReviewerDecision       
  totalRedeemDays    Int?
  maxWeightAllowed   Decimal?  @db.Decimal(10,2)
  maxPassengers      Int
  summary            String    @db.Text
  processingStatus    ReviewProcessingStatus  @default(Pending) 
  processedDate       DateTime?
  severityLevel       ReviewSeverityLevel       @default(OK) 
  requiresOrder       Boolean   @default(false)
  processingError     String?   @db.Text
  originalDocumentPath String?  @db.VarChar(500)
  createdAt         DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  instructions        ReviewInstruction[]
  assemblies         ReviewAssembly[]
  defects            ReviewDefect[]
  safetyOrders       SafetyOrder[]
  alerts             Alert[]
  processingQueue   ProcessingQueue[]

}
enum ReviewSeverityLevel{
  OK // נמוך
  Minor // בינוני
  Medium // גבוה
  Critical // קריטי
}
enum ReviewProcessingStatus{
  Pending // ממתין
  InProgress // בטיפול
  Completed // הושלם
  Error // שגיאה
}
enum ReviewReason{
  RoutineCheck // בדיקה שגרתית
  FirstCheck // ראשונה/מכון התקנים
  PostFixCheck // נוספת לאחר תיקון
  PostRecall // לאחר reacall
  Elevation // הגבהה למעלית בניה
  DrasticChange // שינוי מהותי
} 
enum ReviewerDecision{
 Operateable // ניתן להפעיל
 Disable // להשבית
}

/// הנחיית התסקיר
model ReviewInstruction {
  instructionId        String    @id @db.VarChar(18)
  reviewId             String    @db.VarChar(18)
  review Review @relation(fields: [reviewId], references: [reviewId], onDelete: Cascade)
  productInstruction   String    @db.VarChar(500)
  numberOfDaysToPursue Int?
  createdAt          DateTime  @default(now())
  updatedAt         DateTime  @updatedAt


  @@map("ReviewInstruction")
}


/// נושאים במכללים שנבדקו
model ReviewAssembly {
  assemblyId       String    @id @db.VarChar(18)
  reviewId         String    @db.VarChar(18)
  review Review @relation(fields: [reviewId], references: [reviewId])
  assemblySubject  String    @db.VarChar(200)
  assemblyStatus  AssemblyStatus       
  assemblyNotes   String?   @db.Text
  createdAt      DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

enum AssemblyStatus{
  OK // תקין
  NotOk // לא תקין
  NotChecked // לא נבדק
}

/// כשלים בתסקיר
model ReviewDefect {
  defectId         String    @id @db.VarChar(18)
  reviewId         String    @db.VarChar(18)
  review Review @relation(fields: [reviewId], references: [reviewId])
  assemblySubject  String    @db.VarChar(200)
  subjectFinding   String    @db.VarChar(200)
  defectDescription String? @db.Text
  severity         DefectSeverityLevel       
  isResolved       Boolean   @default(false)
  resolvedDate     DateTime?
  createdAt      DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}
enum DefectSeverityLevel{
  Minor // קל
  Medium // בינוני
  Critical // חמור
}
/// צווי בטיחות
model SafetyOrder {
  orderId             String    @id @db.VarChar(18)
  reviewId            String    @db.VarChar(18)
  assetId             String    @db.VarChar(18)
  inspectorId String    @db.VarChar(18)
  inspector Inspector @relation(fields: [inspectorId], references: [inspectorId])
  orderType           OrderType 
  orderNumber         String    @unique @db.VarChar(50)
  orderContent        String    @db.Text
  issueDate           DateTime  @default(now()) @db.Date
  dueDate             DateTime? @db.Date
  status              OrderStatus       @default(Open)
  isActive            Boolean   @default(true)
  complianceNotes     String?   @db.Text
  complianceDate      DateTime?
  complianceProof     String?   @db.VarChar(500)
  createdAt         DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  review Review @relation(fields: [reviewId], references: [reviewId])
  asset  Asset  @relation(fields: [assetId], references: [assetId])
  alerts Alert[]

}

enum OrderType{
  Disable // השבתה מיידית
  Fix // תיקון ליקויים
  Approve // אישור תקינות
}
enum OrderStatus{
  Open // פתוח
  InProgress // בטיפול
  Expired // פג תוקף
  Closed // בוטל
}

/// התראות
model Alert {
  alertId            String    @id @db.VarChar(18)
  assetId            String?   @db.VarChar(18)
  reviewId           String?   @db.VarChar(18)
  safetyOrderId      String?   @db.VarChar(18)
  inspectorId String   @db.VarChar(18)
  alertType          AlertType 
  priority           AlertPriority
  title              String    @db.VarChar(255)
  description        String    @db.Text
  dueDate            DateTime?
  status             AlertStatus       @default(Open)
  resolvedDate       DateTime?
  resolvedBy         String?   @db.VarChar(18)
  resolutionNotes    String?   @db.Text
  createdAt        DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  inspector Inspector @relation(fields:[inspectorId], references: [inspectorId])
  asset       Asset?       @relation(fields: [assetId], references: [assetId])
  review      Review?      @relation(fields: [reviewId], references: [reviewId])
  safetyOrder SafetyOrder? @relation(fields: [safetyOrderId], references: [orderId])
}
enum AlertPriority{
  Critical // קריטית
  Important // חשובה
  Medium // בינוני
  Information // מידע
}
enum AlertType{
  Danger // סכנה
  SevereDefect // ליקוי חמור
  InspectionDue   //חריגה מזמני טיפול
  ScanningProblem // בעיית סריקה
  Notification // התראה
}
enum AlertStatus{
  Open // פתוח
  InProgress // בטיפול
  Resolved // נסגר
  Rejected // נדחה
}

model ReportTemplate {
  templateId       String      @id @db.VarChar(18)
  name             String      @db.VarChar(255)
  description      String?     @db.Text
  reportType       ReportType  
  queryDefinition  String      @db.Text
  filterDefinition String?     @db.Text
  chartDefinition  String?     @db.Text
  createdBy        String      @db.VarChar(18)
  isPublic         Boolean     @default(false)
  createdAt      DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  savedReports     SavedReport[]
}

/// תבניות דוחות
enum ReportType {
  Status          // 1 = דוח סטטוס
  ElevatorNoReview // 2 = מעליות ללא בדיקה
  InspectorPerformance // 3 = ביצועי בודקים
  SafetyTrends   // 4 = מגמות בטיחות
  Orders          // 5 = צווי
  Custom          // 6 = מותאם אישית
}



model SavedReport {
  reportId        String    @id @db.VarChar(18)
  templateId      String    @db.VarChar(18)
  generatedBy     String    @db.VarChar(18)
  name            String    @db.VarChar(255)
  parameters      String?   @db.Text
  generatedDate   DateTime  @default(now())
  filePath        String    @db.VarChar(500)
  fileType        FileType
  isScheduled     Boolean   @default(false)
  scheduleDefinition String? @db.Text
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  template ReportTemplate @relation(fields: [templateId], references: [templateId])
  inspector Inspector     @relation(fields: [generatedBy], references: [inspectorId])
}
/// דוחות שמורים
enum FileType {
  PDF
  Excel
  PowerPoint
}

/// סיכום נתוני מעלית
model AssetSummary {
  summaryId       String    @id @db.VarChar(18)
  assetId         String    @db.VarChar(18)
  regionId        String    @db.VarChar(18)
  summaryDate     DateTime  @db.Date
  totalInspections Int      @default(0)
  criticalDefects  Int      @default(0)
  minorDefects     Int      @default(0)
  ordersIssued     Int      @default(0)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  asset  Asset  @relation(fields: [assetId], references: [assetId])
  region Region @relation(fields: [regionId], references: [regionId])

  @@unique([assetId, summaryDate])
}


/// מטריקות דשבורד
model DashboardMetrics {
  metricId         String    @id @db.VarChar(18)
  regionId         String?   @db.VarChar(18)
  newReviewsToday  Int       @default(0)
  activeElevators  Int       @default(0)
  disabledElevators Int      @default(0)
  underMaintenance Int       @default(0)
  expiredInspections Int     @default(0)
  criticalAlerts   Int       @default(0)
  pendingOrders    Int       @default(0)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  region Region? @relation(fields: [regionId], references: [regionId])
}

/// תור עיבוד תסקירים
model ProcessingQueue {
  queueId             String    @id @db.VarChar(18)
  emailId             String    @db.VarChar(100)
  emailSubject        String?   @db.VarChar(500)
  emailSender         String    @db.VarChar(255)
  emailReceived       DateTime
  attachmentName      String?   @db.VarChar(255)
  attachmentPath      String?   @db.VarChar(500)
  processingStatus    QueueProcessingStatus       @default(WaitingOCR)
  reviewId            String?   @db.VarChar(18)
  processingStarted   DateTime?
  processingCompleted DateTime?
  errorMessage        String?   @db.Text
  retryCount          Int       @default(0)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime @updatedAt
  review Review? @relation(fields: [reviewId], references: [reviewId])

}
enum QueueProcessingStatus {
  WaitingOCR      // 1
  InProgress       // 2
  AIProcessing    // 3
  Completed        // 4
  Error            // 5
}